<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SchoolBank Viewer</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg,#8B5A9F 0%,#E85A4F 50%,#FFA500 100%);
      min-height:100vh;padding:20px
    }
    .container{max-width:420px;margin:0 auto;background:#fff;border-radius:16px;overflow:hidden;
      box-shadow:0 10px 30px rgba(0,0,0,.2)}
    .header{background:linear-gradient(135deg,#8B5A9F 0%,#E85A4F 100%);color:#fff;padding:24px 20px 16px;
      text-align:center}
    .header h1{font-size:22px;font-weight:600;letter-spacing:.2px}
    .header p{opacity:.9;font-size:13px;margin-top:6px}
    .content{padding:20px}
    .student-card{background:#fff;border-left:5px solid #E85A4F;border-radius:14px;padding:22px;
      box-shadow:0 8px 25px rgba(0,0,0,.12);display:none}
    .student-card.show{display:block;animation:fade .25s ease-out}
    @keyframes fade{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    .student-info{display:flex;justify-content:space-between;gap:12px;margin-bottom:14px}
    .student-name{font-weight:700;color:#333;font-size:18px}
    .student-id{font-size:12px;color:#8B5A9F;font-family:ui-monospace, SFMono-Regular, Menlo, monospace}
    .student-balance{font-size:26px;font-weight:800;color:#E85A4F;white-space:nowrap}
    .transaction-log{margin-top:10px;padding-top:8px;border-top:1px solid #eee}
    .transaction-log h4{font-size:13px;color:#8B5A9F;margin-bottom:8px}
    .log-entry{display:flex;justify-content:space-between;align-items:center;padding:10px 0;
      border-bottom:1px solid #f1e3e3}
    .log-entry:last-child{border-bottom:none}
    .log-left{display:flex;flex-direction:column}
    .log-label{font-size:12px;color:#555}
    .log-amount{font-weight:700}
    .status{display:none;margin:14px 0;padding:12px;border-radius:8px;font-weight:500}
    .status.info{display:block;background:#d1ecf1;color:#0c5460;border:1px solid #bee5eb}
    .status.success{display:block;background:#d4edda;color:#155724;border:1px solid #c3e6cb}
    .status.error{display:block;background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
    .disclaimer{
      margin-top:14px;
      background:#fff9;
      border:2px solid #FDA104;
      border-radius:12px;
      padding:14px;
      color:#8B5A9F;
      font-size:14px;
      text-align:center;
      font-weight:600;
      font-style:italic;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>SchoolBank</h1>
      <p>Ms Fatigato</p>
    </div>

    <div class="content">
      <!-- Card studente: sola lettura -->
      <div id="studentCard" class="student-card">
        <div class="student-info">
          <div>
            <div id="studentName" class="student-name">Nome Studente</div>

          </div>
          <div id="studentBalance" class="student-balance">â‚¬0</div>
        </div>

        <div id="transactionLog" class="transaction-log">
          <h4>Latest transactions:</h4>
          <div id="logEntries"></div>
        </div>
      </div>

      <div id="status" class="status info">Apri con un QR del tipo <code>?id=FF:â€¦</code></div>
      <div id="disclaimer" class="disclaimer"></div>
    </div>
  </div>

  <script>
    // === CONFIG FISSA (hardcoded) ===
    const CONFIG = {
      spreadsheetId: "1sZAEWeKau-ji0sjh_snbhfF2hJjjktHhBdrqhenhzvE",
      apiKey: "AIzaSyCTeDHmE87_9UO31pFLJ5w0keXVDr6-bRA"
    };

    // === FRASI MOTIVAZIONALI ===
    const MOTIVATION_QUOTES = [
      "ðŸ’¡ Spend it wisely!",
      "âœ… Good choices always pay off.",
      "ðŸŒŸ The time spent learning is always well spent!",
      "ðŸš€ Every effort today builds your tomorrow."
    ];

    function showRandomMotivation() {
      const box = document.getElementById('disclaimer');
      const randomIndex = Math.floor(Math.random() * MOTIVATION_QUOTES.length);
      box.textContent = MOTIVATION_QUOTES[randomIndex];
    }

    // ==== Utility Sheets API ====
    async function fetchJSON(url){
      const r = await fetch(url);
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      return r.json();
    }
    function metaURL(){ 
      return `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.spreadsheetId}?key=${CONFIG.apiKey}`;
    }
    function valuesURL(sheetName){
      return `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.spreadsheetId}/values/${encodeURIComponent(sheetName)}?key=${CONFIG.apiKey}`;
    }

    // ==== App Viewer ====
    class Viewer {
      constructor(){
        this.currentStudent = null;
        this.init();
      }
      status(msg,type='info'){
        const el = document.getElementById('status');
        el.textContent = msg;
        el.className = `status ${type}`;
        el.style.display = 'block';
        if(type==='success') setTimeout(()=> el.style.display='none', 2500);
      }
      showCard(){ document.getElementById('studentCard').classList.add('show'); }
      setStudentInfo(st){
        document.getElementById('studentName').textContent = st.name;
        //document.getElementById('studentId').textContent   = `ID: ${st.id}  (Foglio: ${st.classSheet})`;
        document.getElementById('studentBalance').textContent = 'â‚¬' + st.balance.toFixed(2);
      }
      renderLog(items){
        const box = document.getElementById('logEntries');
        if(!items.length){
          box.innerHTML = `<div class="log-entry"><div class="log-left"><span class="log-label">Nessuna voce trovata</span></div><span class="log-amount">â€”</span></div>`;
          return;
        }
        box.innerHTML = items.map(it => `
            <div class="log-entry">
              <div class="log-left"><span class="log-label">${it.label||''}</span></div>
              <span class="log-amount">${it.value}</span>
            </div>`).join('');
      }
      async init(){
        const params = new URLSearchParams(location.search);
        const id = params.get('id');
        if(!id){ this.status('Manca il parametro ?id=...', 'info'); return; }
        try{ await this.loadStudentById(id); }catch(e){ console.error(e); this.status('Errore: '+e.message,'error');}
      }
      async loadStudentById(tagId){
        this.status('Cerco lo studenteâ€¦','info');
        const meta = await fetchJSON(metaURL());
        const titles = (meta.sheets||[]).map(s=>s.properties.title);
        for(const sheetName of titles){
          if(/data$/i.test(sheetName)) continue;
          const data = await fetchJSON(valuesURL(sheetName));
          const rows = data.values||[];
          for(const row of rows){
            const cellId = (row[0]||'').toString().trim();
            if(!cellId) continue;
            if(cellId.toUpperCase().includes(tagId.trim().toUpperCase())){
              const student = {
                id:cellId,
                name:row[1]||'Nome non trovato',
                balance:parseFloat((row[2]||'0').toString().replace(',','.'))||0,
                classSheet:sheetName
              };
              this.currentStudent=student;
              this.setStudentInfo(student);
              this.showCard();
              this.status(`Trovato in: ${sheetName}`,'success');
              const dataSheet=this.findDataSheetName(titles,sheetName);
              if(dataSheet){ await this.loadLastThreeFromDataSheet(student,dataSheet);} else this.renderLog([]);
              return;
            }
          }
        }
        this.status('Studente non trovato: '+tagId,'error');
      }
      findDataSheetName(allTitles,classSheet){
        const candidates=[`${classSheet}data`,`${classSheet} data`,`${classSheet.trim()}Data`];
        for(const c of candidates){ if(allTitles.includes(c)) return c; }
        const lc=classSheet.toLowerCase();
        return allTitles.find(t=>t.toLowerCase().startsWith(lc)&&/data$/.test(t.toLowerCase()))||null;
      }
      async loadLastThreeFromDataSheet(student,dataSheetName){
        try{
          const data=await fetchJSON(valuesURL(dataSheetName));
          const rows=data.values||[];
          if(rows.length<3){ this.renderLog([]); return; }
          const headerRow2=rows[1]||[];
          const target=(student.name||'').trim().toLowerCase();
          let studentRow=[];
          for(const r of rows){ if((r||[]).some(c=>String(c||'').trim().toLowerCase()===target)){studentRow=r;break;} }
          if(studentRow.length===0){ this.renderLog([]); return; }
          const filled=[];
          const maxLen=Math.max(studentRow.length,headerRow2.length);
          for(let c=6;c<maxLen;c++){   //colonna n 6
            const raw=(studentRow[c]!==undefined&&studentRow[c]!==null)?String(studentRow[c]).trim():'';
            if(raw!==''){ filled.push({col:c,value:raw,label:headerRow2[c]||''}); }
          }
          const last3=filled.slice(-5); //le ultime 5 transazioni
          this.renderLog(last3);
        }catch(e){ console.error(e); this.status(`Errore lettura "${dataSheetName}": ${e.message}`,'error'); this.renderLog([]);}
      }
    }

    document.addEventListener('DOMContentLoaded',()=>{
      new Viewer();
      showRandomMotivation(); // Mostra frase random nel disclaimer
    });
  </script>
</body>
</html>
