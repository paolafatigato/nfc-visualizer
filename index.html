<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SchoolBank Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #8B5A9F 0%, #E85A4F 50%, #FFA500 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #8B5A9F 0%, #E85A4F 100%);
            color: white;
            padding: 25px 20px 15px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
            font-weight: 300;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 20px;
        }

        .student-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin: 0 0 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            display: none;
            border-left: 5px solid #E85A4F;
        }

        .student-card.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        .student-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .student-name {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        .student-balance {
            font-size: 32px;
            font-weight: bold;
            color: #E85A4F;
        }

        .student-id {
            font-size: 12px;
            color: #8B5A9F;
            font-family: monospace;
            margin-top: 5px;
        }

        .transaction-log {
            margin-top: 20px;
        }

        .transaction-log h4 {
            margin: 0 0 15px;
            color: #8B5A9F;
            font-size: 16px;
            font-weight: 600;
        }

        .log-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-bottom: 10px;
            background: rgba(139, 90, 159, 0.05);
            border-radius: 8px;
            border-left: 3px solid #8B5A9F;
        }

        .log-description {
            font-size: 13px;
            color: #666;
            font-style: italic;
        }

        .log-amount {
            font-weight: bold;
            font-size: 16px;
        }

        .log-amount.positive {
            color: #8B5A9F;
        }

        .log-amount.negative {
            color: #E85A4F;
        }

        .status {
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
            display: none;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .test-section {
            background: rgba(255,255,255,0.9);
            border: 2px dashed #E85A4F;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            backdrop-filter: blur(10px);
        }

        .test-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #E85A4F;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .test-button {
            background: linear-gradient(135deg, #8B5A9F, #E85A4F);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(139,90,159,0.3);
        }

        .config-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .config-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }

        .input-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .save-button {
            width: 100%;
            background: linear-gradient(135deg, #8B5A9F, #E85A4F);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .save-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(139,90,159,0.3);
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #8B5A9F;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>SchoolBank</h1>
            <p>Ms Fatigato</p>
        </div>

        <div class="content">
            <div id="studentCard" class="student-card">
                <div class="student-info">
                    <div>
                        <div class="student-name" id="studentName">Nome Studente</div>
                        <div class="student-id" id="studentId">ID: ABC123</div>
                    </div>
                    <div class="student-balance" id="studentBalance">€0.00</div>
                </div>

                <div class="transaction-log">
                    <h4>Ultime Transazioni:</h4>
                    <div id="logEntries" class="loading">Caricamento transazioni...</div>
                </div>
            </div>



            <div id="status" class="status"></div>

            
        </div>
    </div>

    <script>
        class NFCViewer {
            constructor() {
                this.config = this.loadConfig();
                this.currentStudent = null;
                this.initializeApp();
            }

            loadConfig() {
                const saved = localStorage.getItem('nfc_viewer_config');
                return saved ? JSON.parse(saved) : {
                    spreadsheetId: '1sZAEWeKau-ji0sjh_snbhfF2hJjjktHhBdrqhenhzvE',
                    apiKey: ''
                };
            }

            saveConfig() {
                const config = {
                    spreadsheetId: document.getElementById('spreadsheetId').value,
                    apiKey: document.getElementById('apiKey').value
                };
                
                localStorage.setItem('nfc_viewer_config', JSON.stringify(config));
                this.config = config;
                this.showStatus('Configurazione salvata', 'success');
            }

            initializeApp() {
                document.getElementById('spreadsheetId').value = this.config.spreadsheetId;
                document.getElementById('apiKey').value = this.config.apiKey;
            }

            async searchStudent(tagId) {
                try {
                    this.showStatus('Cercando studente...', 'info');

                    const metaUrl = `https://sheets.googleapis.com/v4/spreadsheets/${this.config.spreadsheetId}?key=${this.config.apiKey}`;
                    const metaRes = await fetch(metaUrl);
                    
                    if (!metaRes.ok) throw new Error(`Errore API: ${metaRes.status}`);

                    const metadata = await metaRes.json();
                    const sheets = metadata.sheets || [];

                    for (const sh of sheets) {
                        const sheetName = sh.properties.title;
                        if (/data$/i.test(sheetName)) continue;

                        try {
                            const url = `https://sheets.googleapis.com/v4/spreadsheets/${this.config.spreadsheetId}/values/${encodeURIComponent(sheetName)}?key=${this.config.apiKey}`;
                            const res = await fetch(url);
                            if (!res.ok) continue;
                            
                            const data = await res.json();
                            const rows = data.values || [];

                            for (let i = 0; i < rows.length; i++) {
                                const row = rows[i];
                                const cellId = row[0] ? row[0].toString().trim() : '';
                                
                                if (cellId === tagId.trim() || cellId.includes(tagId.trim())) {
                                    const student = {
                                        id: cellId,
                                        name: row[1] || 'Nome non trovato',
                                        balance: parseFloat(row[2] || 0),
                                        sheetName,
                                        rowIndex: i + 1
                                    };
                                    
                                    this.displayStudent(student);
                                    await this.loadTransactions(student);
                                    return;
                                }
                            }
                        } catch (err) {
                            console.log(`Errore foglio ${sheetName}:`, err);
                            continue;
                        }
                    }

                    this.showStatus('Studente non trovato', 'error');
                } catch (error) {
                    this.showStatus('Errore: ' + error.message, 'error');
                }
            }

            displayStudent(student) {
                this.currentStudent = student;
                
                document.getElementById('studentName').textContent = student.name;
                document.getElementById('studentId').textContent = `ID: ${student.id} (Foglio: ${student.sheetName})`;
                document.getElementById('studentBalance').textContent = '€' + student.balance.toFixed(2);
                
                document.getElementById('studentCard').classList.add('show');
                this.showStatus('Studente trovato', 'success');
            }

            async loadTransactions(student) {
                const logEntries = document.getElementById('logEntries');
                logEntries.innerHTML = '<div class="loading">Caricamento transazioni...</div>';

                try {
                    const dataSheetName = student.sheetName + 'data';
                    
                    // Carica il foglio data
                    const url = `https://sheets.googleapis.com/v4/spreadsheets/${this.config.spreadsheetId}/values/${encodeURIComponent(dataSheetName)}?key=${this.config.apiKey}`;
                    const res = await fetch(url);
                    
                    if (!res.ok) throw new Error('Foglio data non trovato');
                    
                    const data = await res.json();
                    const rows = data.values || [];
                    
                    if (student.rowIndex > rows.length) {
                        logEntries.innerHTML = '<div style="text-align:center;color:#999">Nessuna transazione registrata</div>';
                        return;
                    }
                    
                    // Prendi le descrizioni dalla riga 2 (indice 1)
                    const descriptions = rows[1] || [];
                    
                    // Prendi la riga dello studente
                    const studentRow = rows[student.rowIndex - 1] || [];
                    
                    // Trova le ultime 3 colonne piene (dalla Z=25 in poi)
                    const transactions = [];
                    for (let col = studentRow.length - 1; col >= 25 && transactions.length < 3; col--) {
                        const value = studentRow[col];
                        if (value !== null && value !== undefined && value !== '') {
                            const amount = parseFloat(value);
                            const description = descriptions[col] || 'Transazione';
                            
                            transactions.push({
                                amount: amount,
                                description: description
                            });
                        }
                    }
                    
                    if (transactions.length === 0) {
                        logEntries.innerHTML = '<div style="text-align:center;color:#999">Nessuna transazione registrata</div>';
                        return;
                    }
                    
                    // Mostra le transazioni (dalla più recente alla meno recente)
                    let html = '';
                    for (const trans of transactions) {
                        const amountClass = trans.amount >= 0 ? 'positive' : 'negative';
                        const amountStr = trans.amount >= 0 ? `+€${trans.amount.toFixed(2)}` : `-€${Math.abs(trans.amount).toFixed(2)}`;
                        
                        html += `
                            <div class="log-entry">
                                <div>
                                    <div class="log-amount ${amountClass}">${amountStr}</div>
                                    <div class="log-description">${trans.description}</div>
                                </div>
                            </div>
                        `;
                    }
                    
                    logEntries.innerHTML = html;
                    
                } catch (error) {
                    console.error('Errore caricamento transazioni:', error);
                    logEntries.innerHTML = '<div style="text-align:center;color:#E85A4F">Errore caricamento transazioni</div>';
                }
            }

            showStatus(message, type) {
                const el = document.getElementById('status');
                el.textContent = message;
                el.className = `status ${type}`;
                el.style.display = 'block';
                
                if (type === 'success') {
                    setTimeout(() => { el.style.display = 'none'; }, 3000);
                }
            }

            validateConfig() {
                return this.config.spreadsheetId && this.config.apiKey;
            }
        }

        function saveConfig() {
            window.nfcViewer.saveConfig();
        }

        function testSearch() {
            const v = document.getElementById('testId').value;
            if (v) window.nfcViewer.searchStudent(v);
        }

        document.addEventListener('DOMContentLoaded', () => {
            window.nfcViewer = new NFCViewer();
            
            const urlParams = new URLSearchParams(window.location.search);
            const cardId = urlParams.get('id');
            
            if (cardId) {
                document.getElementById('testId').value = cardId;
                setTimeout(() => {
                    if (window.nfcViewer.validateConfig()) {
                        window.nfcViewer.searchStudent(cardId);
                    } else {
                        window.nfcViewer.showStatus('Configura prima l\'API Key', 'error');
                    }
                }, 1200);
            }
        });
    </script>
</body>
</html>
